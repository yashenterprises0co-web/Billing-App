<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Billing Pro — Invoice / Challan / Quotation (Final)</title>
<meta name="description" content="Single-file billing app: invoices, challans, quotations. Auto-save, 24h lock with admin override, GST split, number-to-words (Indian), UPI QR, PDF/Word export, import, library.">
<style>
  :root{--bg:#f7fbff;--card:#fff;--muted:#6b7280;--accent:#0b74ff;--success:#16a34a;--danger:#dc2626;--warning:#d97706}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg),#fff);color:#111}
  .container{max-width:1280px;margin:18px auto;padding:16px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  h1{font-size:18px;margin:0}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
  .btn.ghost{background:transparent;border:1px dashed #ddd;color:var(--muted)}
  .btn.warn{background:var(--warning);color:#111}
  .btn.danger{background:var(--danger)}
  .small{padding:6px 8px;font-size:13px}
  .chip{display:inline-block;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;font-weight:600}
  .layout{display:grid;grid-template-columns:340px 1fr 360px;gap:16px;margin-top:16px}
  .panel{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(13,17,23,0.04)}
  label{display:block;font-size:12px;color:var(--muted);margin-top:8px}
  input[type=text],input[type=tel],input[type=date],input[type=number],select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6edf3;margin-top:6px;font-size:14px}
  textarea{min-height:80px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  table th,table td{border:1px solid #e6edf3;padding:8px;text-align:left;vertical-align:middle}
  table th{background:#f1f5f9}
  .image-thumb{max-width:90px;max-height:60px;border-radius:6px}
  .muted{color:var(--muted);font-size:13px}
  .error{color:#b91c1c;font-size:12px}
  .doc-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #f3f4f6}
  .tag{padding:4px 8px;border-radius:6px;background:#f1f5f9;font-size:12px}
  .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:50}
  .modal.show{display:flex}
  .modal .box{background:#fff;padding:18px;border-radius:10px;width:920px;max-width:92%;box-shadow:0 8px 30px rgba(2,6,23,.2);max-height:90vh;overflow:auto}
  .row{display:flex;gap:8px;align-items:center}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
  .split{display:flex;gap:12px;align-items:center}
  .right{order:3}
  @media (max-width:1100px){.layout{grid-template-columns:1fr}.right{order:3}}
  @media print{
    body{background:#fff}
    header,.right,.toolbar,#editorPanel .no-print{display:none!important}
    .panel{box-shadow:none}
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>Billing Pro • Invoice / Challan / Quotation <span id="lockBadge" class="chip" style="display:none">Locked</span></h1>
      <div class="muted" id="appSubtitle">All-in-one billing • Auto-save • 24-hour lock (admin override)</div>
    </div>
    <div class="toolbar">
      <button class="btn" id="btnNew" title="New document">New</button>
      <button class="btn ghost" id="btnLibrary">Library</button>
      <button class="btn ghost" id="btnPrint">Print</button>
      <button class="btn" id="btnAdmin">Admin</button>
      <select id="langSelect" title="UI language">
        <option value="en">English</option>
        <option value="hi">हिंदी</option>
        <option value="mr">मराठी</option>
      </select>
    </div>
  </header>

  <div class="layout">
    <!-- LEFT: Editor Panel -->
    <aside class="panel" id="editorPanel">
      <div class="grid2">
        <div>
          <label>Document Type</label>
          <select id="docType"><option>Invoice</option><option>Challan</option><option>Quotation</option></select>
        </div>
        <div>
          <label>Document No</label>
          <input type="text" id="docNo" placeholder="INV-2025-001">
        </div>
      </div>
      <div class="grid2">
        <div>
          <label>Date</label>
          <input type="date" id="docDate">
        </div>
        <div>
          <label>Currency</label>
          <select id="currency">
            <option value="INR">₹ INR</option>
            <option value="USD">$ USD</option>
            <option value="EUR">€ EUR</option>
            <option value="GBP">£ GBP</option>
            <option value="AED">د.إ AED</option>
            <option value="AUD">A$ AUD</option>
          </select>
        </div>
      </div>

      <label>Logo</label>
      <input type="file" id="logoFile" accept="image/*">
      <img id="logoPreview" style="max-width:140px;margin-top:8px;display:block;border-radius:6px" alt="logo preview">

      <h4 style="margin:10px 0 0 0">From (Company)</h4>
      <input type="text" id="fromName" placeholder="Company name">
      <textarea id="fromAddr" placeholder="Address"></textarea>
      <div class="grid3">
        <div>
          <label>Company Contact (10 digits)</label>
          <input type="tel" id="fromPhone" placeholder="9876543210">
          <div class="error" id="fromPhoneErr" style="display:none">Enter exactly 10 digits</div>
        </div>
        <div>
          <label>Default Tax %</label>
          <input type="number" id="defaultTax" value="0" step="0.01">
        </div>
        <div>
          <label>Round-off total</label>
          <select id="roundOff"><option value="none">No</option><option value="nearest">Nearest</option><option value="down">Round Down</option><option value="up">Round Up</option></select>
        </div>
      </div>

      <h4 style="margin:10px 0 0 0">To (Customer)</h4>
      <input type="text" id="toName" placeholder="Customer name">
      <textarea id="toAddr" placeholder="Address"></textarea>
      <label>Customer Contact (10 digits)</label>
      <input type="tel" id="toPhone" placeholder="9876543210">
      <div class="error" id="toPhoneErr" style="display:none">Enter exactly 10 digits</div>

      <div class="grid2" style="margin-top:8px">
        <div>
          <label>Terms & Conditions</label>
          <textarea id="terms">Payment due within 30 days.</textarea>
        </div>
        <div>
          <label>UPI ID (for QR)</label>
          <input type="text" id="upiId" placeholder="merchant@upi">
          <label>UPI Name</label>
          <input type="text" id="upiName" placeholder="Your Company">
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px" class="no-print">
        <button class="btn small" id="btnAddItem">Add Item</button>
        <button class="btn small" id="btnSave">Save</button>
        <button class="btn small" id="btnExportPDF">Export PDF</button>
        <button class="btn small" id="btnExportDoc">Export Word</button>
        <button class="btn ghost small" id="btnImport">Import JSON</button>
      </div>
    </aside>

    <!-- CENTER: Preview / Items -->
    <main class="panel" id="previewPanel">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
        <div style="display:flex;gap:12px;align-items:center">
          <img id="logoSmall" style="height:64px;border-radius:6px;display:none" alt="logo small">
          <div>
            <div id="previewFromName" style="font-weight:700">Company</div>
            <div id="previewFromAddr" class="muted"></div>
            <div id="previewFromPhone" class="muted"></div>
          </div>
        </div>
        <div style="text-align:right;min-width:240px">
          <div id="previewType" style="font-weight:800;font-size:18px">Invoice</div>
          <div class="muted">No: <span id="previewNo"></span></div>
          <div class="muted">Date: <span id="previewDate"></span></div>
          <div class="muted">Currency: <span id="previewCurr"></span></div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="muted">Bill To</div>
        <div id="previewToName" style="font-weight:700">Customer</div>
        <div id="previewToAddr" class="muted"></div>
        <div id="previewToPhone" class="muted"></div>
      </div>

      <table id="itemsTable">
        <thead>
          <tr>
            <th>Image</th>
            <th>Description</th>
            <th>HSN/SAC</th>
            <th>Unit</th>
            <th>Qty</th>
            <th>Rate</th>
            <th>Disc %</th>
            <th>Tax %</th>
            <th>Amount</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>

      <div style="display:flex;gap:12px;align-items:center;margin-top:12px;flex-wrap:wrap">
        <div>
          <label>Global Discount %</label>
          <input type="number" id="discount" value="0" step="0.01">
        </div>
        <div>
          <label>Shipping</label>
          <input type="number" id="shipping" value="0" step="0.01">
        </div>
        <div>
          <label>Other Charges</label>
          <input type="number" id="other" value="0" step="0.01">
        </div>
        <div style="margin-left:auto;text-align:right">
          <div class="muted">Subtotal: <span id="subtotal">0.00</span></div>
          <div class="muted">Line Discounts: <span id="lineDiscVal">0.00</span></div>
          <div class="muted">Global Discount: <span id="discountVal">0.00</span></div>
          <div class="muted">Tax: <span id="taxVal">0.00</span> <span id="gstSplit" class="muted"></span></div>
          <div class="muted">Shipping + Other: <span id="shipOther">0.00</span></div>
          <div class="muted">Round Off: <span id="roundVal">0.00</span></div>
          <div style="font-weight:800;font-size:16px">Grand Total: <span id="grandTotal">0.00</span></div>
          <div class="muted" id="amountWords" style="margin-top:6px"></div>
        </div>
      </div>

      <div style="margin-top:12px">
        <strong>Terms & Conditions</strong>
        <p class="muted" id="termsPreview"></p>
      </div>

      <div id="upiSection" style="margin-top:12px;display:none">
        <strong>UPI Payment</strong>
        <div class="split">
          <div>
            <div class="muted">Scan to pay</div>
            <div id="upiQr"></div>
          </div>
          <div class="muted" id="upiText"></div>
        </div>
      </div>
    </main>

    <!-- RIGHT: Library & Actions -->
    <aside class="panel right" id="rightPanel">
      <h3 style="margin:0 0 8px 0">Document Library</h3>

      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input type="text" id="searchBox" placeholder="Search by client or doc no" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6edf3">
        <select id="filterType" style="width:140px">
          <option value="">All</option><option>Invoice</option><option>Challan</option><option>Quotation</option>
        </select>
      </div>

      <div id="libraryList" style="max-height:420px;overflow:auto;border:1px solid #f3f4f6;border-radius:8px"></div>

      <hr style="margin:12px 0">

      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn" id="btnShare">Share (Web Share/WhatsApp)</button>
        <button class="btn ghost" id="btnDelete" title="Delete current (Admin only)">Delete Current</button>
      </div>

      <div style="margin-top:12px">
        <h4 class="muted">App Settings</h4>
        <label>Language (UI)</label>
        <select id="uiLang"><option value="en">English</option><option value="hi">हिंदी</option><option value="mr">मराठी</option></select>
        <label>Default Currency</label>
        <select id="defCurrency">
          <option value="INR">₹ INR</option>
          <option value="USD">$ USD</option>
          <option value="EUR">€ EUR</option>
          <option value="GBP">£ GBP</option>
          <option value="AED">د.إ AED</option>
          <option value="AUD">A$ AUD</option>
        </select>
        <label style="margin-top:8px">Custom Terms (Default)</label>
        <textarea id="defaultTerms" style="min-height:80px"></textarea>
        <label>Default Tax %</label>
        <input type="number" id="defTax" value="0" step="0.01">
        <label>Company Name (Default)</label>
        <input type="text" id="defCompany">
        <label>Company Address (Default)</label>
        <textarea id="defAddress"></textarea>
        <label>Company Phone (Default)</label>
        <input type="tel" id="defPhone" placeholder="9876543210">
        <label>Auto-save on change</label>
        <select id="autoSave"><option value="1">On</option><option value="0">Off</option></select>
        <button class="btn small" id="saveSettings">Save Settings</button>
      </div>
    </aside>
  </div>
</div>

<!-- Admin modal -->
<div class="modal" id="adminModal">
  <div class="box" style="width:420px">
    <h3>Admin</h3>
    <p class="muted">Admin can edit/delete locked documents and change settings.</p>
    <label>Password</label>
    <input type="password" id="adminPassInput">
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn" id="adminLoginBtn">Login</button>
      <button class="btn ghost" id="adminCloseBtn">Close</button>
    </div>
    <hr/>
    <label>Change Admin Password</label>
    <input type="password" id="adminNewPass">
    <button class="btn small" id="adminSetBtn">Set Password</button>
    <p class="muted" style="margin-top:8px">Default password (demo): <strong>admin123</strong>. Change after first use.</p>
  </div>
</div>

<!-- Document view modal -->
<div class="modal" id="docViewModal">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <h3 id="docViewTitle">Document</h3>
      <div>
        <button class="btn small" id="docViewEditBtn">Edit</button>
        <button class="btn small" id="docViewDownloadBtn">Download JSON</button>
        <button class="btn ghost small" id="docViewCloseBtn">Close</button>
      </div>
    </div>
    <div id="docViewContent" style="margin-top:12px"></div>
  </div>
</div>

<!-- QR, jsPDF & AutoTable CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js" crossorigin="anonymous"></script>

<script>
(function(){
  'use strict';

  // ---------- Utilities ----------
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const fmt = (n, c) => Number(n||0).toLocaleString(undefined,{style:'currency',currency: c||currency.value || 'INR',minimumFractionDigits:2,maximumFractionDigits:2});
  const nowISO = () => new Date().toISOString();
  const saveBlob = (blob, name) => { const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),30000); };
  const toFixed2 = n => (Math.round((Number(n)||0)*100)/100);
  const clampNum = (v,min,max)=> Math.min(max, Math.max(min, Number(v)||0));

  // Number to words (Indian system)
  function inrToWords(num){
    num = Math.round(Number(num)||0);
    if(num===0) return 'Zero Rupees';
    const a=['','One','Two','Three','Four','Five','Six','Seven','Eight','Nine','Ten','Eleven','Twelve','Thirteen','Fourteen','Fifteen','Sixteen','Seventeen','Eighteen','Nineteen'];
    const b=['','','Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];
    function two(n){ if(n<20) return a[n]; const t=Math.floor(n/10), r=n%10; return b[t]+(r?(' '+a[r]):''); }
    function three(n){ const h=Math.floor(n/100), r=n%100; return (h? a[h]+' Hundred' + (r?' ':'') : '') + (r? two(r):''); }
    let out='';
    const crore=Math.floor(num/10000000); num%=10000000;
    const lakh=Math.floor(num/100000); num%=100000;
    const thousand=Math.floor(num/1000); num%=1000;
    const hundred=num;
    if(crore) out+= three(crore)+' Crore ';
    if(lakh) out+= three(lakh)+' Lakh ';
    if(thousand) out+= two(thousand)+' Thousand ';
    if(hundred) out+= three(hundred);
    return out.trim() + ' Rupees Only';
  }

  // ---------- Elements ----------
  const btnNew = $('#btnNew'), btnLibrary = $('#btnLibrary'), btnAdmin = $('#btnAdmin');
  const btnPrint = $('#btnPrint');
  const langSelect = $('#langSelect');
  const editorPanel = $('#editorPanel'), previewPanel = $('#previewPanel');
  const docType = $('#docType'), logoFile = $('#logoFile'), logoPreview = $('#logoPreview'), logoSmall = $('#logoSmall');
  const fromName = $('#fromName'), fromAddr = $('#fromAddr'), fromPhone = $('#fromPhone'), fromPhoneErr = $('#fromPhoneErr');
  const toName = $('#toName'), toAddr = $('#toAddr'), toPhone = $('#toPhone'), toPhoneErr = $('#toPhoneErr');
  const docNo = $('#docNo'), docDate = $('#docDate'), currency = $('#currency'), defaultTax = $('#defaultTax'), terms = $('#terms');
  const btnAddItem = $('#btnAddItem'), btnSave = $('#btnSave'), btnExportPDF = $('#btnExportPDF'), btnExportDoc = $('#btnExportDoc');
  const btnImport = $('#btnImport');
  const itemsBody = $('#itemsBody'), discount = $('#discount'), shipping = $('#shipping'), other = $('#other');
  const subtotalEl = $('#subtotal'), discountEl = $('#discountVal'), taxEl = $('#taxVal'), grandEl = $('#grandTotal');
  const lineDiscEl = $('#lineDiscVal'), shipOtherEl = $('#shipOther'), roundValEl = $('#roundVal');
  const previewFromName = $('#previewFromName'), previewFromAddr = $('#previewFromAddr'), previewFromPhone = $('#previewFromPhone'), previewToName = $('#previewToName'), previewToAddr = $('#previewToAddr'), previewToPhone = $('#previewToPhone');
  const previewType = $('#previewType'), previewNo = $('#previewNo'), previewDate = $('#previewDate'), previewCurr = $('#previewCurr'), termsPreview = $('#termsPreview');
  const gstSplit = $('#gstSplit'), amountWords = $('#amountWords');
  const upiSection = $('#upiSection'), upiQrEl = $('#upiQr'), upiText = $('#upiText'), upiId = $('#upiId'), upiName = $('#upiName');
  const libraryList = $('#libraryList'), searchBox = $('#searchBox'), filterType = $('#filterType');
  const btnShare = $('#btnShare'), btnDelete = $('#btnDelete');
  const uiLang = $('#uiLang'), defCurrency = $('#defCurrency'), defaultTerms = $('#defaultTerms'), defTax = $('#defTax'), defCompany = $('#defCompany'), defAddress = $('#defAddress'), defPhone = $('#defPhone'), autoSave = $('#autoSave'), roundOffSel = $('#roundOff');
  const adminModal = $('#adminModal'), adminLoginBtn = $('#adminLoginBtn'), adminCloseBtn = $('#adminCloseBtn'), btnAdminSet = $('#adminSetBtn');
  const adminPassInput = $('#adminPassInput'), adminNewPass = $('#adminNewPass');
  const docViewModal = $('#docViewModal'), docViewContent = $('#docViewContent'), docViewCloseBtn = $('#docViewCloseBtn'), docViewDownloadBtn = $('#docViewDownloadBtn'), docViewEditBtn = $('#docViewEditBtn');
  const lockBadge = $('#lockBadge');

  // ---------- State ----------
  let docs = JSON.parse(localStorage.getItem('docs')||'[]');             // saved documents
  let settings = JSON.parse(localStorage.getItem('appSettings')||'{}');
  settings = Object.assign({uiLang:'en', defaultTerms:'Payment due within 30 days.', companyName:'', companyAddress:'', companyPhone:'', defCurrency:'INR', defTax:0, autoSave:1}, settings||{});
  let admin = { loggedIn: sessionStorage.getItem('adminLogged') === '1', password: localStorage.getItem('adminPass') || 'admin123' };
  let currentDoc = null; // doc being edited (object) or null
  let items = [];        // items list for current editor
  let logoData = '';     // logo base64
  let qr = null;         // QR instance

  // ---------- Helpers ----------
  function uid(){ return 'd_' + Math.random().toString(36).slice(2,10); }
  function isPhone(v){ return /^\d{10}$/.test((v||'').trim()); }
  function addHours(iso, hours){ const d=new Date(iso); d.setHours(d.getHours()+hours); return d.toISOString(); }
  function isEditable(doc){ if(!doc) return false; if(admin.loggedIn) return true; return new Date() < new Date(addHours(doc.createdAt,24)); }
  function persist(){ localStorage.setItem('docs', JSON.stringify(docs)); }
  function persistSettings(){ localStorage.setItem('appSettings', JSON.stringify(settings)); }
  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

  function setCurrentDoc(doc){
    currentDoc = doc ? JSON.parse(JSON.stringify(doc)) : null;
    items = currentDoc ? (currentDoc.items||[]) : [];
    logoData = currentDoc ? currentDoc.logo || '' : '';
    renderEditorFromDoc();
    renderItemsTable();
    recalcTotals();
    renderPreview();
    updateLockBadge();
  }

  function updateLockBadge(){
    const locked = currentDoc ? !isEditable(currentDoc) : false;
    lockBadge.style.display = locked ? 'inline-block' : 'none';
  }

  // ---------- Rendering ----------
  function renderEditorFromDoc(){
    if(!currentDoc){
      docType.value = 'Invoice';
      docNo.value = 'INV-'+ new Date().getFullYear() + '-' + String((docs.filter(d=>d.type==='Invoice').length+1)).padStart(3,'0');
      docDate.value = new Date().toISOString().slice(0,10);
      currency.value = settings.defCurrency || 'INR';
      fromName.value = settings.companyName || '';
      fromAddr.value = settings.companyAddress || '';
      fromPhone.value = settings.companyPhone || '';
      defaultTax.value = settings.defTax || 0;
      toName.value = '';
      toAddr.value = '';
      toPhone.value = '';
      terms.value = settings.defaultTerms || 'Payment due within 30 days.';
      items = items.length ? items : [{desc:'',hsn:'',unit:'Nos',qty:1,rate:0,discount:0,tax: Number(defaultTax.value)||0,image:''}];
      logoPreview.src = logoData || '';
      logoSmall.style.display = logoData ? 'inline-block' : 'none';
    } else {
      docType.value = currentDoc.type;
      docNo.value = currentDoc.number || '';
      docDate.value = currentDoc.date || '';
      currency.value = currentDoc.currency || settings.defCurrency || 'INR';
      defaultTax.value = currentDoc.defaultTax ?? settings.defTax ?? 0;
      fromName.value = currentDoc.from?.name || settings.companyName || '';
      fromAddr.value = currentDoc.from?.address || settings.companyAddress || '';
      fromPhone.value = currentDoc.from?.phone || settings.companyPhone || '';
      toName.value = currentDoc.to?.name || '';
      toAddr.value = currentDoc.to?.address || '';
      toPhone.value = currentDoc.to?.phone || '';
      terms.value = currentDoc.terms || settings.defaultTerms || '';
      items = JSON.parse(JSON.stringify(currentDoc.items || []));
      logoData = currentDoc.logo || '';
      logoPreview.src = logoData || '';
      logoSmall.src = logoData || '';
      logoSmall.style.display = logoData ? 'inline-block' : 'none';
    }
    renderPreview();
  }

  function newItem(){
    return {desc:'',hsn:'',unit:'Nos',qty:1,rate:0,discount:0,tax: Number(defaultTax.value)||0,image:''};
  }

  function renderItemsTable(){
    itemsBody.innerHTML = '';
    items.forEach((it, idx) => {
      const tr = document.createElement('tr');

      // image
      const tdImg = document.createElement('td');
      const fileIn = document.createElement('input'); fileIn.type='file'; fileIn.accept='image/*'; fileIn.style.width='100px';
      const img = document.createElement('img'); img.className='image-thumb'; img.style.display = it.image ? 'block' : 'none'; if(it.image) img.src = it.image;
      fileIn.addEventListener('change', async e=>{
        const f = e.target.files && e.target.files[0]; if(!f) return;
        try{ const d = await readFileAsDataURL(f); it.image = d; img.src = d; img.style.display='block'; updateAmount(idx); autoSaveMaybe(); } catch(e){ console.error(e); }
      });
      tdImg.appendChild(fileIn); tdImg.appendChild(img);

      // desc
      const tdDesc = document.createElement('td'); const inpDesc = document.createElement('input'); inpDesc.type='text'; inpDesc.value = it.desc||''; inpDesc.placeholder='Description'; inpDesc.addEventListener('input', e=>{ it.desc = e.target.value; renderPreview(); autoSaveMaybe(); }); tdDesc.appendChild(inpDesc);

      // hsn
      const tdHsn = document.createElement('td'); const inpHsn = document.createElement('input'); inpHsn.type='text'; inpHsn.value = it.hsn||''; inpHsn.placeholder='HSN/SAC'; inpHsn.addEventListener('input', e=> {it.hsn = e.target.value; autoSaveMaybe();}); tdHsn.appendChild(inpHsn);

      // unit
      const tdUnit = document.createElement('td'); const inpUnit = document.createElement('input'); inpUnit.type='text'; inpUnit.value = it.unit||'Nos'; inpUnit.placeholder='Unit'; inpUnit.addEventListener('input', e=> {it.unit = e.target.value; autoSaveMaybe();}); tdUnit.appendChild(inpUnit);

      // qty
      const tdQty = document.createElement('td'); const inpQty = document.createElement('input'); inpQty.type='number'; inpQty.step='0.01'; inpQty.min='0'; inpQty.value = it.qty||0; inpQty.addEventListener('input', e=>{ it.qty = Number(e.target.value)||0; updateAmount(idx); autoSaveMaybe(); }); tdQty.appendChild(inpQty);

      // rate
      const tdRate = document.createElement('td'); const inpRate = document.createElement('input'); inpRate.type='number'; inpRate.step='0.01'; inpRate.min='0'; inpRate.value = it.rate||0; inpRate.addEventListener('input', e=>{ it.rate = Number(e.target.value)||0; updateAmount(idx); autoSaveMaybe(); }); tdRate.appendChild(inpRate);

      // per-line discount
      const tdLDisc = document.createElement('td'); const inpLDisc = document.createElement('input'); inpLDisc.type='number'; inpLDisc.step='0.01'; inpLDisc.min='0'; inpLDisc.value = it.discount||0; inpLDisc.addEventListener('input', e=>{ it.discount = clampNum(e.target.value,0,100); e.target.value = it.discount; updateAmount(idx); autoSaveMaybe(); }); tdLDisc.appendChild(inpLDisc);

      // tax
      const tdTax = document.createElement('td'); const inpTax = document.createElement('input'); inpTax.type='number'; inpTax.step='0.01'; inpTax.min='0'; inpTax.value = it.tax||0; inpTax.addEventListener('input', e=>{ it.tax = Number(e.target.value)||0; updateAmount(idx); autoSaveMaybe(); }); tdTax.appendChild(inpTax);

      // amount
      const tdAmt = document.createElement('td'); tdAmt.className = 'right-align'; tdAmt.textContent = fmt(lineAmount(it), currency.value);

      // action
      const tdAct = document.createElement('td');
      const rem = document.createElement('button'); rem.className='small btn warn'; rem.textContent='Remove'; rem.addEventListener('click', ()=>{ items.splice(idx,1); renderItemsTable(); recalcTotals(); autoSaveMaybe(); });
      tdAct.appendChild(rem);

      tr.appendChild(tdImg); tr.appendChild(tdDesc); tr.appendChild(tdHsn); tr.appendChild(tdUnit); tr.appendChild(tdQty); tr.appendChild(tdRate); tr.appendChild(tdLDisc); tr.appendChild(tdTax); tr.appendChild(tdAmt); tr.appendChild(tdAct);
      itemsBody.appendChild(tr);

      function updateAmount(){ tdAmt.textContent = fmt(lineAmount(it), currency.value); recalcTotals(false); renderPreview(); }
    });
  }

  function lineAmount(it){
    const base = (Number(it.qty)||0) * (Number(it.rate)||0);
    const lDisc = base * ((Number(it.discount)||0)/100);
    const taxable = base - lDisc;
    const taxAmt = taxable * ((Number(it.tax)||0)/100);
    return toFixed2(taxable + taxAmt);
  }

  async function readFileAsDataURL(f){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); }); }

  function recalcTotals(renderPrev = true){
    // subtotal before any discount & tax
    const sub = items.reduce((s,it)=> s + ((Number(it.qty)||0)*(Number(it.rate)||0)),0);
    const lineDisc = items.reduce((s,it)=> s + ((Number(it.qty)||0)*(Number(it.rate)||0))*((Number(it.discount)||0)/100),0);
    const tax = items.reduce((s,it)=> { const base=(Number(it.qty)||0)*(Number(it.rate)||0); const lDisc= base*((Number(it.discount)||0)/100); const taxable=base - lDisc; return s + (taxable*((Number(it.tax)||0)/100)); },0);
    const gDisc = (sub - lineDisc) * ((Number(discount.value)||0)/100);
    const shipOther = (Number(shipping.value)||0) + (Number(other.value)||0);
    let grand = (sub - lineDisc - gDisc) + tax + shipOther;

    // round-off
    let roundShown = 0;
    const ro = roundOffSel.value;
    if(ro !== 'none'){
      const rounded = ro==='nearest' ? Math.round(grand) : (ro==='down' ? Math.floor(grand) : Math.ceil(grand));
      roundShown = toFixed2(rounded - grand);
      grand = rounded;
    }

    subtotalEl.textContent = fmt(sub, currency.value);
    lineDiscEl.textContent = fmt(lineDisc, currency.value);
    discountEl.textContent = fmt(gDisc, currency.value);
    taxEl.textContent = fmt(tax, currency.value);
    shipOtherEl.textContent = fmt(shipOther, currency.value);
    roundValEl.textContent = fmt(roundShown, currency.value);
    grandEl.textContent = fmt(grand, currency.value);

    // GST split when currency INR
    if(currency.value==='INR'){
      const cgst = tax/2, sgst = tax/2; // simplified split
      gstSplit.textContent = `(CGST ${fmt(cgst,'INR')} + SGST ${fmt(sgst,'INR')})`;
      amountWords.textContent = inrToWords(grand);
    } else {
      gstSplit.textContent = '';
      amountWords.textContent = '';
    }

    if(renderPrev) renderPreview();
  }

  function renderPreview(){
    previewFromName.textContent = fromName.value || '';
    previewFromAddr.textContent = fromAddr.value || '';
    previewFromPhone.textContent = fromPhone.value || '';
    previewToName.textContent = toName.value || '';
    previewToAddr.textContent = toAddr.value || '';
    previewToPhone.textContent = toPhone.value || '';
    previewType.textContent = docType.value;
    previewNo.textContent = docNo.value;
    previewDate.textContent = docDate.value;
    previewCurr.textContent = currency.value;
    termsPreview.textContent = terms.value || settings.defaultTerms || '';
    logoSmall.style.display = logoData ? 'inline-block' : 'none';
    if(logoData){ logoSmall.src = logoData; logoPreview.src = logoData; }

    // UPI QR
    const upi = (upiId.value||'').trim();
    if(upi && currency.value==='INR'){
      const amountStr = grandEl.textContent.replace(/[^0-9.]/g,'');
      const url = `upi://pay?pa=${encodeURIComponent(upi)}&pn=${encodeURIComponent(upiName.value||fromName.value||'')}&am=${encodeURIComponent(amountStr||'')}&cu=INR`;
      upiSection.style.display = 'block';
      upiText.textContent = url;
      if(!qr){ qr = new QRCode(upiQrEl, {text:url,width:110,height:110}); }
      else { upiQrEl.innerHTML=''; qr = new QRCode(upiQrEl, {text:url,width:110,height:110}); }
    } else {
      upiSection.style.display = 'none';
      upiQrEl.innerHTML='';
      qr = null;
    }
  }

  function renderLibrary(){
    libraryList.innerHTML = '';
    const q = (searchBox.value||'').toLowerCase();
    const typeFilter = filterType.value;
    const list = docs.filter(d => {
      if(typeFilter && d.type !== typeFilter) return false;
      if(!q) return true;
      return (d.to?.name||'').toLowerCase().includes(q) || (d.number||'').toLowerCase().includes(q);
    });
    list.forEach(d => {
      const el = document.createElement('div'); el.className='doc-row';
      const left = document.createElement('div');
      left.innerHTML = `<div style="font-weight:700">${escapeHtml(d.type)} • ${escapeHtml(d.number||'')}</div><div class="muted">${escapeHtml(d.to?.name||'')} • ${new Date(d.createdAt).toLocaleString()}</div>`;
      const right = document.createElement('div');
      const total = (d.items||[]).reduce((s,it)=> s + lineAmount(it),0);
      const span = document.createElement('span'); span.className='tag'; span.textContent = fmt(total, d.currency||currency.value);
      const status = document.createElement('div'); status.className='muted'; status.style.marginTop='4px';
      status.textContent = isEditable(d) ? 'Editable' : 'Locked';
      const viewBtn = document.createElement('button'); viewBtn.className='small btn'; viewBtn.textContent = 'View';
      viewBtn.addEventListener('click', ()=> openDocView(d.id));
      right.appendChild(span); right.appendChild(status); right.appendChild(document.createElement('br')); right.appendChild(viewBtn);
      el.appendChild(left); el.appendChild(right);
      libraryList.appendChild(el);
    });
  }

  function clearEditor(){
    currentDoc = null; items = [newItem()]; logoData=''; logoPreview.src=''; logoSmall.style.display='none';
    renderEditorFromDoc(); renderItemsTable(); recalcTotals(); renderPreview(); updateLockBadge();
  }

  // ---------- Document lifecycle ----------
  function createDocumentObject(){
    const doc = {
      id: currentDoc?.id || uid(),
      type: docType.value,
      number: docNo.value || ('DOC-'+Date.now()),
      date: docDate.value || new Date().toISOString().slice(0,10),
      currency: currency.value,
      defaultTax: Number(defaultTax.value)||0,
      from: { name: fromName.value, address: fromAddr.value, phone: fromPhone.value },
      to: { name: toName.value, address: toAddr.value, phone: toPhone.value },
      items: JSON.parse(JSON.stringify(items)),
      discount: Number(discount.value)||0,
      shipping: Number(shipping.value)||0,
      other: Number(other.value)||0,
      terms: terms.value,
      logo: logoData,
      createdAt: currentDoc?.createdAt || nowISO(),
      lastModified: nowISO()
    };
    return doc;
  }

  function saveCurrentDoc(showAlert=true){
    // validation
    if(fromPhone.value && !isPhone(fromPhone.value)){ fromPhoneErr.style.display='block'; if(showAlert) alert('Company phone invalid'); return false; } else fromPhoneErr.style.display='none';
    if(toPhone.value && !isPhone(toPhone.value)){ toPhoneErr.style.display='block'; if(showAlert) alert('Customer phone invalid'); return false; } else toPhoneErr.style.display='none';

    const newDoc = createDocumentObject();
    if(currentDoc && currentDoc.id){
      const idx = docs.findIndex(d => d.id === currentDoc.id);
      if(idx === -1){ if(showAlert) alert('Document not found'); return false; }
      if(!isEditable(docs[idx])){ if(showAlert) alert('This document is locked (editable only within 24 hours). Admin can override.'); return false; }
      newDoc.id = docs[idx].id; newDoc.createdAt = docs[idx].createdAt; newDoc.lastModified = nowISO();
      docs[idx] = newDoc; currentDoc = JSON.parse(JSON.stringify(newDoc));
    } else {
      docs.unshift(newDoc); currentDoc = JSON.parse(JSON.stringify(newDoc));
    }
    persist(); renderLibrary(); updateLockBadge();
    if(showAlert) alert('Saved locally');
    return true;
  }

  function autoSaveMaybe(){ if(Number(settings.autoSave||1)===1){ saveCurrentDoc(false); } }

  function openDocView(id){
    const doc = docs.find(d => d.id === id);
    if(!doc) return alert('Document not found');
    docViewContent.innerHTML = buildDocHTML(doc, true);
    $('#docViewTitle').textContent = `${doc.type} • ${doc.number}`;
    docViewModal.classList.add('show');
    docViewDownloadBtn.onclick = () => saveBlob(new Blob([JSON.stringify(doc,null,2)],{type:'application/json'}), (doc.number||'doc') + '.json');
    docViewEditBtn.onclick = () => {
      if(!isEditable(doc) && !admin.loggedIn){ return alert('This document is locked for editing'); }
      setCurrentDoc(doc);
      docViewModal.classList.remove('show');
    };
  }

  function buildDocHTML(doc){
    // return HTML markup for print/view
    const rows = doc.items.map(it=>{
      const base = (Number(it.qty)||0)*(Number(it.rate)||0);
      const ldisc = base*((Number(it.discount)||0)/100);
      const taxable = base - ldisc;
      const tax = taxable*((Number(it.tax)||0)/100);
      const amt = (taxable + tax).toFixed(2);
      return `<tr><td>${escapeHtml(it.desc||'')}</td><td>${escapeHtml(it.hsn||'')}</td><td>${escapeHtml(it.unit||'')}</td><td>${it.qty||0}</td><td>${it.rate||0}</td><td>${it.discount||0}</td><td>${it.tax||0}</td><td>${amt}</td></tr>`;
    }).join('');

    const subtotal = doc.items.reduce((s,it)=> s+((it.qty||0)*(it.rate||0)),0);
    const lineDisc = doc.items.reduce((s,it)=> s+((it.qty||0)*(it.rate||0))*((it.discount||0)/100),0);
    const tax = doc.items.reduce((s,it)=>{ const base=(it.qty||0)*(it.rate||0); const l=base*((it.discount||0)/100); return s + ((base-l)*((it.tax||0)/100)); },0);
    const gDisc = (subtotal - lineDisc) * ((doc.discount||0)/100);
    const totals = {
      subtotal, lineDisc, gDisc, tax, shipOther:(doc.shipping||0)+(doc.other||0),
    };
    const grandRaw = (subtotal - lineDisc - gDisc) + tax + totals.shipOther;
    const grand = grandRaw;

    let gstSplitTxt = '';
    if(doc.currency==='INR'){
      const cgst = tax/2, sgst = tax/2; gstSplitTxt = `(CGST ${cgst.toFixed(2)} + SGST ${sgst.toFixed(2)})`;
    }

    return `
      <div>
        <h2>${escapeHtml(doc.type)} • ${escapeHtml(doc.number||'')}</h2>
        <div style="display:flex;justify-content:space-between;gap:10px">
          <div><strong>From:</strong> ${escapeHtml(doc.from.name||'')}<br/>${escapeHtml(doc.from.address||'')}<br/>${escapeHtml(doc.from.phone||'')}</div>
          <div><strong>To:</strong> ${escapeHtml(doc.to.name||'')}<br/>${escapeHtml(doc.to.address||'')}<br/>${escapeHtml(doc.to.phone||'')}</div>
          <div><strong>Date:</strong> ${escapeHtml(doc.date||'')}<br/><strong>Currency:</strong> ${escapeHtml(doc.currency||'')}</div>
        </div>
        <table border="1" cellspacing="0" cellpadding="6" style="width:100%;margin-top:8px">
          <thead><tr><th>Desc</th><th>HSN</th><th>Unit</th><th>Qty</th><th>Rate</th><th>Disc%</th><th>Tax%</th><th>Amount</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
        <div style="margin-top:8px"><strong>Totals:</strong><br/>
          Subtotal: ${subtotal.toFixed(2)}<br/>
          Line Discounts: ${lineDisc.toFixed(2)}<br/>
          Global Discount: ${gDisc.toFixed(2)}<br/>
          Tax: ${tax.toFixed(2)} ${gstSplitTxt}<br/>
          Shipping + Other: ${((doc.shipping||0)+(doc.other||0)).toFixed(2)}<br/>
          <strong>Grand: ${grand.toFixed(2)} ${doc.currency||''}</strong>
        </div>
        <div style="margin-top:8px"><strong>Terms:</strong><br/>${escapeHtml(doc.terms||'')}</div>
      </div>`;
  }

  // ---------- Exports ----------
  btnExportPDF.addEventListener('click', ()=> {
    try {
      const d = createDocumentObject();
      if(!window.jspdf) return alert('PDF engine not available');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();

      // header
      pdf.setFontSize(16); pdf.text(`${d.type} - ${d.number}`,14,14);
      pdf.setFontSize(10);
      pdf.text(`From: ${d.from.name}`,14,22);
      pdf.text(`To: ${d.to.name}`,14,28);
      pdf.text(`Date: ${d.date}   Currency: ${d.currency}`,14,34);

      // table
      const rows = d.items.map(it=>{
        const base = (Number(it.qty)||0)*(Number(it.rate)||0);
        const ldisc = base*((Number(it.discount)||0)/100);
        const taxable = base - ldisc;
        const tax = taxable*((Number(it.tax)||0)/100);
        const amt = (taxable+tax).toFixed(2);
        return [it.desc||'', it.hsn||'', it.unit||'', String(it.qty||0), String(it.rate||0), String(it.discount||0), String(it.tax||0), amt];
      });
      pdf.autoTable({
        startY: 40,
        head: [['Desc','HSN','Unit','Qty','Rate','Disc %','Tax %','Amount']],
        body: rows,
        styles:{fontSize:9}
      });

      // totals
      let y = pdf.lastAutoTable.finalY + 6;
      const sub = items.reduce((s,it)=> s + ((Number(it.qty)||0)*(Number(it.rate)||0)),0);
      const lineDisc = items.reduce((s,it)=> s + ((Number(it.qty)||0)*(Number(it.rate)||0))*((Number(it.discount)||0)/100),0);
      const tax = items.reduce((s,it)=> { const base=(Number(it.qty)||0)*(Number(it.rate)||0); const l= base*((Number(it.discount)||0)/100); return s + ((base - l)*((Number(it.tax)||0)/100)); },0);
      const gDisc = (sub - lineDisc) * ((Number(discount.value)||0)/100);
      const shipOther = (Number(shipping.value)||0) + (Number(other.value)||0);
      const ro = roundOffSel.value;
      let grand = (sub - lineDisc - gDisc) + tax + shipOther;
      let roundShown = 0; if(ro!=='none'){ const rounded = ro==='nearest'?Math.round(grand):(ro==='down'?Math.floor(grand):Math.ceil(grand)); roundShown = (rounded - grand); grand = rounded; }

      const gstTxt = currency.value==='INR'?` (CGST ${(tax/2).toFixed(2)} + SGST ${(tax/2).toFixed(2)})`:'';

      pdf.text(`Subtotal: ${sub.toFixed(2)}`, 120, y); y+=5;
      pdf.text(`Line Discounts: ${lineDisc.toFixed(2)}`, 120, y); y+=5;
      pdf.text(`Global Discount: ${gDisc.toFixed(2)}`, 120, y); y+=5;
      pdf.text(`Tax: ${tax.toFixed(2)}${gstTxt}`, 120, y); y+=5;
      pdf.text(`Shipping + Other: ${shipOther.toFixed(2)}`, 120, y); y+=5;
      pdf.text(`Round Off: ${roundShown.toFixed(2)}`, 120, y); y+=6;
      pdf.setFontSize(12); pdf.text(`Grand Total: ${grand.toFixed(2)} ${currency.value}`, 120, y);

      if(currency.value==='INR'){
        pdf.setFontSize(10); y+=6; pdf.text(`Amount in words: ${inrToWords(grand)}`,14,y);
      }

      pdf.save((d.number||'document')+'.pdf');
    } catch(e){
      console.error(e); alert('PDF export failed: ' + e.message);
    }
  });

  btnExportDoc.addEventListener('click', ()=>{
    const d = createDocumentObject();
    const html = buildDocHTML(d);
    const full = `<!doctype html><html><head><meta charset="utf-8"><title>${escapeHtml(d.number||'document')}</title></head><body>${html}</body></html>`;
    saveBlob(new Blob([full],{type:'application/msword'}), (d.number||'document') + '.doc');
  });

  // ---------- Import ----------
  btnImport.addEventListener('click', ()=>{
    const inp = document.createElement('input'); inp.type='file'; inp.accept='.json,application/json';
    inp.onchange = async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      try{ const txt = await f.text(); const obj = JSON.parse(txt);
        if(Array.isArray(obj)){ docs = obj.concat(docs); persist(); renderLibrary(); alert('Imported document list'); }
        else if(obj && typeof obj==='object'){ setCurrentDoc(obj); saveCurrentDoc(); alert('Imported document'); }
      } catch(err){ alert('Import failed: '+err.message); }
    };
    inp.click();
  });

  // ---------- Sharing ----------
  btnShare.addEventListener('click', ()=>{
    const d = createDocumentObject();
    const lines = [];
    lines.push(`${d.type} • ${d.number}`);
    lines.push(`From: ${d.from.name}`);
    lines.push(`To: ${d.to.name}`);
    d.items.forEach(it => lines.push(`- ${it.desc||''}, Qty:${it.qty}, Rate:${it.rate}, Disc:${it.discount}%, Tax:${it.tax}%`));
    const grandText = grandEl.textContent.replace(/\s+/g,' ');
    lines.push(`Grand Total: ${grandText}`);
    const text = lines.join('\n');
    if(navigator.share){
      navigator.share({title: d.number, text}).catch(()=> window.open('https://wa.me/?text=' + encodeURIComponent(text)));
    } else {
      window.open('https://wa.me/?text=' + encodeURIComponent(text));
    }
  });

  // ---------- Delete (Admin) ----------
  btnDelete.addEventListener('click', ()=>{
    if(!currentDoc) return alert('No current document');
    if(!admin.loggedIn) return alert('Admin only');
    const idx = docs.findIndex(d=>d.id===currentDoc.id);
    if(idx===-1) return alert('Not found');
    if(confirm('Delete current document?')){ docs.splice(idx,1); persist(); clearEditor(); renderLibrary(); alert('Deleted'); }
  });

  // ---------- Admin ----------
  btnAdmin.addEventListener('click', ()=> adminModal.classList.add('show'));
  adminCloseBtn.addEventListener('click', ()=> adminModal.classList.remove('show'));
  adminLoginBtn.addEventListener('click', ()=> {
    const v = adminPassInput.value || '';
    if(v === admin.password){ admin.loggedIn = true; sessionStorage.setItem('adminLogged','1'); adminModal.classList.remove('show'); alert('Admin login success'); renderLibrary(); updateLockBadge(); }
    else alert('Wrong password');
  });
  btnAdminSet.addEventListener('click', ()=> {
    const nv = adminNewPass.value || '';
    if(nv.length < 4) return alert('Password >= 4 chars');
    admin.password = nv; localStorage.setItem('adminPass', nv); adminNewPass.value=''; alert('Admin password updated');
  });

  // ---------- UI events ----------
  btnNew.addEventListener('click', ()=> { clearEditor(); });
  btnLibrary.addEventListener('click', ()=> { renderLibrary(); });
  btnPrint.addEventListener('click', ()=> window.print());

  logoFile.addEventListener('change', async e => {
    const f = e.target.files && e.target.files[0]; if(!f) return;
    logoData = await readFileAsDataURL(f); logoPreview.src = logoData; logoSmall.src = logoData; logoSmall.style.display='inline-block'; autoSaveMaybe();
  });

  btnAddItem.addEventListener('click', ()=> { items.push(newItem()); renderItemsTable(); recalcTotals(); autoSaveMaybe(); });

  btnSave.addEventListener('click', ()=> { const ok = saveCurrentDoc(); if(ok){ renderLibrary(); }});

  // reactive fields -> preview + autosave
  [docType, docNo, docDate, currency, defaultTax, fromName, fromAddr, fromPhone, toName, toAddr, toPhone, terms, discount, shipping, other, upiId, upiName, roundOffSel].forEach(el=>{
    el.addEventListener('input', ()=>{ renderPreview(); recalcTotals(); autoSaveMaybe(); if((el===docType || el===docNo) && currentDoc){ currentDoc.type=docType.value; currentDoc.number=docNo.value; }});
    el.addEventListener('change', ()=>{ renderPreview(); recalcTotals(); autoSaveMaybe(); });
  });

  searchBox.addEventListener('input', ()=> renderLibrary());
  filterType.addEventListener('change', ()=> renderLibrary());

  // Settings load/save
  function loadSettingsIntoUI(){
    uiLang.value = settings.uiLang || 'en';
    defaultTerms.value = settings.defaultTerms || 'Payment due within 30 days.';
    defCurrency.value = settings.defCurrency || 'INR';
    defTax.value = settings.defTax || 0;
    defCompany.value = settings.companyName || '';
    defAddress.value = settings.companyAddress || '';
    defPhone.value = settings.companyPhone || '';
    autoSave.value = String(settings.autoSave||1);
  }

  $('#saveSettings').addEventListener('click', ()=>{
    settings.uiLang = uiLang.value;
    settings.defaultTerms = defaultTerms.value;
    settings.defCurrency = defCurrency.value;
    settings.defTax = Number(defTax.value)||0;
    settings.companyName = defCompany.value;
    settings.companyAddress = defAddress.value;
    settings.companyPhone = defPhone.value;
    settings.autoSave = Number(autoSave.value)||1;
    persistSettings();
    alert('Settings saved');
    renderLibrary();
  });

  // initial boot
  function initApp(){
    loadSettingsIntoUI();
    docDate.value = new Date().toISOString().slice(0,10);
    renderLibrary();
    clearEditor();
  }

  // Close modals when clicking outside
  [adminModal, docViewModal].forEach(m => { m.addEventListener('click', (ev) => { if(ev.target === m) m.classList.remove('show'); }); });
  docViewCloseBtn.addEventListener('click', ()=> docViewModal.classList.remove('show'));

  initApp();
})();
</script>
</body>
</html>
